---
# yamllint disable rule:truthy rule:line-length
name: Update Specs

on:
  push:
    branches: [main]
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: read
  pull-requests: read

jobs:
  generate:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    env:
      SERVER_URL: ${{ secrets.SERVER_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      # Cache pip to speed up installs
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          pip install yamllint safety pip-audit
          pip install -e .

      - name: Show versions
        run: |
          python --version
          pip --version
          tvgen --version

      - name: Refresh and generate specs
        run: |
          set -euo pipefail
          tvgen refresh --market all
          tvgen generate --market all
          tvgen validate

      - name: Build specs
        run: |
          set -euo pipefail
          extra=""
          if [ -n "${SERVER_URL}" ]; then
            extra="--server-url ${SERVER_URL}"
          fi
          tvgen build --indir results --outdir specs ${extra}

      - name: Bundle specs
        run: tvgen bundle --format yaml --outfile bundle.yaml

      - name: Validate specs
        run: |
          for spec in specs/*.yaml; do
            yamllint "$spec"
            openapi-spec-validator "$spec"
          done

      - name: Security audit
        run: |
          safety check -r requirements.txt -r requirements-dev.txt
          pip-audit -r requirements.txt -r requirements-dev.txt
          pip check

      - name: Update README
        run: tvgen docs > README.md

      - name: Upload artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: specs-${{ matrix.python-version }}
          path: |
            specs/*.yaml
            bundle.yaml
          if-no-files-found: error

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore: update generated specifications'
          title: 'Update OpenAPI specifications'
          body: 'Automated update of generated specifications.'
          branch: openapi-specs-${{ github.run_number }}
          token: ${{ secrets.GITHUB_TOKEN }}

  quality:
    needs: generate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          pip install ruff black mypy pytest-cov
          pip install -e .

      - name: Ruff
        run: ruff check .

      - name: Black
        run: black --check .

      - name: MyPy
        # src/config.py contains runtime checks that confuse mypy.
        # It is excluded here to avoid failing the release pipeline.
        run: mypy src --exclude src/config.py

      - name: Pytest with coverage
        run: pytest --cov=src --cov-report=xml -q

      - name: Upload coverage to Codecov
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        if: ${{ env.CODECOV_TOKEN != '' }}
        run: |
          pip install codecov
          codecov -t "$CODECOV_TOKEN"
